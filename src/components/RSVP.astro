---
import { UNDANGAN_CONFIG } from '../data/config'
import OrnamentBackground from './OrnamentBackground.astro'
---

<div
  id="rsvp"
  class="angkasa_slide px-4 sm:px-6 relative min-h-screen flex flex-col justify-center items-center snap-start"
  data-section="rsvp"
>
  <OrnamentBackground />

  <div
    class="blur-card bg-white/30 backdrop-blur-sm animated-content rounded-3xl mt-7 h-full w-full flex flex-col justify-center items-center z-10"
  >
    <div class="content-layer text-center p-6 max-w-sm mx-auto">
      <h3
        data-animation-class="animate__fadeInDown"
        class="ornament-item text-3xl font-judul italic color-accent-2 border-b border-rose-gold pb-2 mb-4 inline-block"
      >
        ✤ Kehadiran ✤
      </h3>

      <div
        data-animation-class="animate__zoomIn"
        class="text-lg ornament-item font-dekor-1 font-semibold mb-4 animate__slower"
      >
        Kepada Yth.
        <span id="rsvp-greeting-name" class="color-accent text-xl font-nama">[Nama Tamu]</span>,
      </div>

      <p
        data-animation-class="animate__fadeInUp"
        class="font-medium ornament-item font-dekor-1 text-[15px] mb-8 animate__slower"
      >
        Merupakan suatu kehormatan bagi kami apabila Anda berkenan hadir untuk memberikan doa restu.
        Mohon konfirmasi kehadiran melalui tombol di bawah ini.
      </p>

      <button
        data-animation-class="animate__fadeInUp"
        id="open-rsvp-modal-btn"
        onclick="openModal('rsvp-form-modal')"
        class="ornament-item inline-block px-6 py-3 text-sm font-bold color-accent-2 uppercase duration-300 rounded-full shadow-inner border border-accent mx-auto hover:bg-white/10 animate__delay-2s"
      >
        <i class="fas fa-calendar-check mr-2"></i> Konfirmasi Kehadiran
      </button>
    </div>
  </div>
</div>

<!-- ========================== MODAL ========================== -->

<div
  id="rsvp-form-modal"
  class="modal-backdrop hidden fixed inset-0 z-[200] flex items-center justify-center p-4 py-6 bg-white/30 backdrop-blur-md transition-opacity duration-300 opacity-0"
>
  <div class="modal-content w-full h-full overflow-hidden transform scale-95 transition-all">
    <div
      class="bg-white rounded-2xl shadow-2xl p-6 text-center relative"
      style="border:2px solid var(--inv-accent)"
    >
      <div class="space-y-4 text-left">
        <div>
          <label class="block text-sm mb-1">Nama Anda: <span class="text-red-500">*</span></label>
          <input
            id="rsvp-name-modal"
            type="text"
            class="mt-1 block w-full py-2 px-3 bg-white/30 backdrop-blur-md border border-(--inv-border) rounded-xl shadow-sm"
            placeholder="Nama Anda"
          />
        </div>

        <!-- ================= CUSTOM SELECT ================= -->
        <div>
          <label class="block text-sm font-bold mb-1">Apakah Anda akan hadir?</label>

          <div class="custom-select-wrapper">
            <div
              id="status-dropdown"
              class="custom-select-display border border-(--inv-border) rounded-xl"
            >
              <span id="status-text">Hadir</span>
              <i class="fa-solid fa-chevron-down arrow-icon"></i>
            </div>

            <div id="status-options" class="custom-select-options hidden">
              <div class="option-item" data-value="Hadir">Ya, saya akan hadir</div>
              <div class="option-item" data-value="Tidak Hadir">
                Mohon maaf, saya tidak bisa hadir
              </div>
            </div>

            <!-- Hidden real value -->
            <input type="hidden" id="rsvp-status-modal" value="Hadir" />
          </div>
        </div>
        <!-- ================================================== -->

        <div>
          <label class="block text-sm mb-1 pt-2">Pesan / Doa (Opsional):</label>
          <textarea
            id="rsvp-message-modal"
            rows="3"
            class="mt-1 block w-full py-2 px-3 border rounded-xl border-(--inv-border)"
            placeholder="Tuliskan ucapan dan doa terbaik Anda..."></textarea>
        </div>
      </div>

      <button
        id="send-rsvp-btn-modal"
        class="w-full mt-6 px-4 py-3 text-sm font-bold text-white bg-lime-600 rounded-2xl hover:bg-lime-700"
      >
        <i class="fa-solid fa-envelope-circle-check mr-2"></i> Kirim Konfirmasi
      </button>

      <button onclick="closeModal('rsvp-form-modal')" class="mt-3 text-xs mx-auto">Batal</button>

      <div
        id="rsvp-messages-container"
        class="mt-6 max-h-80 min-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200"
      >
        <div id="rsvp-messages" class="flex flex-col space-y-2"></div>
      </div>

      <button id="load-more-btn" class="mt-2 text-sm text-lime-600 hover:underline"
        >Lihat lebih banyak</button
      >
    </div>

    <div
      id="success-toast"
      class="fixed bottom-5 right-5 hidden p-4 rounded-xl shadow-2xl z-[500] transition-all duration-300 transform translate-x-full"
      style="background:#22c55e;color:white;"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-3 text-xl"></i>
        <span class="font-bold text-sm">Konfirmasi berhasil dikirim!</span>
      </div>
    </div>
  </div>
</div>

<!-- ========================== CSS DROPDOWN ========================== -->
<style>
  .custom-select-wrapper {
    width: 100%;
    position: relative;
  }

  .custom-select-display {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    padding: 12px 16px;
    font-size: 15px;
    font-weight: 600;
    color: #3a3a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: 0.25s;
  }

  .custom-select-display:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  .arrow-icon {
    transition: transform 0.25s;
  }

  .custom-select-options {
    position: absolute;
    top: 110%;
    width: 100%;
    left: 0;

    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(12px);

    border: 1px solid rgba(213, 180, 155, 0.4);
    border-radius: 12px;

    padding: 6px 0;
    box-shadow: 0 5px 18px rgba(0, 0, 0, 0.15);

    animation: fadeDropdown 0.18s ease;
    z-index: 99;
  }

  @keyframes fadeDropdown {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .option-item {
    padding: 10px 16px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 600;
    color: #4b4b4b;
  }

  .option-item:hover {
    background: rgba(213, 180, 155, 0.2);
    color: var(--inv-accent);
    border-radius: 8px;
  }
</style>

<!-- ========================== SCRIPT ========================== -->
<script>
  import { firebase, db } from '~/data/firebase.js'

  window.showSuccessToast = function () {
    const toast = document.getElementById('success-toast')
    if (!toast) return

    toast.classList.remove('hidden')
    requestAnimationFrame(() => {
      toast.classList.remove('translate-x-full')
    })

    setTimeout(() => {
      toast.classList.add('translate-x-full')
      setTimeout(() => toast.classList.add('hidden'), 300)
    }, 3000)
  }

  /** CUSTOM DROPDOWN */
  document.addEventListener('DOMContentLoaded', () => {
    const display = document.getElementById('status-dropdown')
    const options = document.getElementById('status-options')
    const text = document.getElementById('status-text')
    const hiddenInput = document.getElementById('rsvp-status-modal')
    const arrow = display.querySelector('.arrow-icon')

    display.addEventListener('click', () => {
      options.classList.toggle('hidden')
      arrow.style.transform = options.classList.contains('hidden')
        ? 'rotate(0deg)'
        : 'rotate(180deg)'
    })

    document.querySelectorAll('.option-item').forEach((opt) => {
      opt.addEventListener('click', () => {
        const value = opt.dataset.value
        hiddenInput.value = value
        text.textContent = value

        options.classList.add('hidden')
        arrow.style.transform = 'rotate(0deg)'
      })
    })

    document.addEventListener('click', (e) => {
      if (!display.contains(e.target) && !options.contains(e.target)) {
        options.classList.add('hidden')
        arrow.style.transform = 'rotate(0deg)'
      }
    })
  })

  /** FIREBASE SYSTEM (RSVP) */
  let allMessages = []
  let visibleCount = 6

  document.addEventListener('DOMContentLoaded', () => {
    const formBtn = document.getElementById('send-rsvp-btn-modal')
    const messagesDiv = document.getElementById('rsvp-messages')
    const nameInput = document.getElementById('rsvp-name-modal')
    const loadMoreBtn = document.getElementById('load-more-btn')
    const rsvpGreetingName = document.getElementById('rsvp-greeting-name')
    const rsvpStatusModal = document.getElementById('rsvp-status-modal')
    const rsvpMessageModal = document.getElementById('rsvp-message-modal')

    const guestName = window.getGuestNameFromUrl ? window.getGuestNameFromUrl() : 'Tamu'
    rsvpGreetingName.textContent = guestName
    nameInput.value = guestName.replace(/\+/g, ' ')

    formBtn.addEventListener('click', () => {
      db.ref('rsvp').push({
        name: nameInput.value.trim() || 'Tamu Undangan',
        status: rsvpStatusModal.value,
        message: rsvpMessageModal.value,
        count: 1,
        timestamp: Date.now()
      })

      window.showSuccessToast()
      rsvpMessageModal.value = ''
    })

    function renderMessages() {
      if (!messagesDiv) return

      messagesDiv.innerHTML = ''
      const messagesToShow = allMessages.slice().reverse().slice(0, visibleCount)

      messagesToShow.forEach((data) => {
        const isHadir = data.status === 'Hadir'
        const wrapper = document.createElement('div')
        wrapper.className = `
            flex items-end mb-3 
            ${isHadir ? 'justify-start' : 'justify-end'} 
            opacity-0 translate-y-3
            `

        const avatar = document.createElement('div')
        const initials = data.name.charAt(0).toUpperCase()
        avatar.innerText = initials
        avatar.className = `
            w-8 h-8 rounded-full flex items-center justify-center
            text-white font-semibold shadow 
            bg-gray-400 flex-shrink-0
            `

        const time = new Date(data.timestamp)
        const hh = time.getHours().toString().padStart(2, '0')
        const mm = time.getMinutes().toString().padStart(2, '0')

        const bubble = document.createElement('div')
        bubble.className = `
            relative px-4 py-2 rounded-lg shadow max-w-[75%] w-fit break-words
            ${isHadir ? 'bg-lime-100 text-left rounded-bl-none' : 'bg-red-100 text-right rounded-br-none'}
            `

        bubble.innerHTML = `
            <div class="text-xs text-gray-500 font-semibold mb-1">
                ${data.name} • ${hh}:${mm}
            </div>
            <div class="text-sm mb-1">${data.message || '<i>Tidak ada pesan</i>'}</div>
            <div class="text-xs text-gray-600">Status: ${data.status}</div>
            `

        if (isHadir) {
          wrapper.appendChild(avatar)
          wrapper.appendChild(bubble)
        } else {
          wrapper.appendChild(bubble)
          wrapper.appendChild(avatar)
        }

        messagesDiv.appendChild(wrapper)

        requestAnimationFrame(() => {
          wrapper.style.transition = 'all 0.25s ease'
          wrapper.style.opacity = 1
          wrapper.style.transform = 'translateY(0)'
        })
      })

      messagesDiv.scrollTop = messagesDiv.scrollHeight
    }

    if (messagesDiv) {
      db.ref('rsvp')
        .orderByChild('timestamp')
        .on('value', (snapshot) => {
          const data = snapshot.val() || {}
          allMessages = Object.values(data).sort((a, b) => a.timestamp - b.timestamp)
          renderMessages()
        })
    }

    loadMoreBtn.addEventListener('click', () => {
      visibleCount += 6
      renderMessages()
    })

    function cleanupOldMessages() {
      const now = Date.now()
      db.ref('rsvp').once('value', (snapshot) => {
        const data = snapshot.val() || {}
        Object.entries(data).forEach(([key, msg]) => {
          if (now - msg.timestamp > 86400000) {
            db.ref('rsvp/' + key).remove()
          }
        })
      })
    }

    cleanupOldMessages()
    setInterval(cleanupOldMessages, 3600000)
  })
</script>
