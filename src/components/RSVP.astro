---
// @ts-nocheck
// src/components/RSVP.astro
import { UNDANGAN_CONFIG } from '../data/config'
import OrnamentBackground from './OrnamentBackground.astro'
---

<!-- RSVP -->
<div
  id="rsvp"
  class="angkasa_slide px-4 sm:px-6 relative min-h-screen flex flex-col justify-center items-center snap-start"
  data-section="rsvp"
>
  <OrnamentBackground />

  <div
    class="blur-card bg-white/30 backdrop-blur-sm animated-content rounded-3xl mt-7 h-full w-full flex flex-col justify-center items-center z-10"
  >
    <div class="content-layer text-center p-6 max-w-sm mx-auto">
      <h3
        data-animation-class="animate__fadeInDown"
        class="ornament-item text-3xl font-judul italic color-accent-2 border-b border-rose-gold pb-2 mb-4 inline-block"
      >
        ✤ Kehadiran ✤
      </h3>

      <div
        data-animation-class="animate__zoomIn"
        class="text-lg ornament-item font-dekor-1 font-semibold mb-4 animate__slower"
      >
        Kepada Yth.
        <span id="rsvp-greeting-name" class="color-accent text-xl font-nama">[Nama Tamu]</span>,
      </div>

      <p
        data-animation-class="animate__fadeInUp"
        class="font-medium ornament-item font-dekor-1 text-[15px] mb-8 animate__slower"
      >
        Merupakan suatu kehormatan dan kebahagiaan bagi kami apabila Bapak/Ibu/Saudara/i berkenan
        hadir untuk memberikan doa restu.
        <br /><br />
        Mohon konfirmasi kehadiran Anda melalui tombol di bawah ini.
      </p>

      <button
        data-animation-class="animate__fadeInUp"
        id="open-rsvp-modal-btn"
        onclick="openModal('rsvp-form-modal')"
        class="ornament-item inline-block px-6 py-3 text-sm font-bold color-accent-2 uppercase duration-300 rounded-full shadow-inner border border-accent max-width-[150px] mx-auto hover:bg-white/10 transform transition animate__delay-2s"
      >
        <i class="fas fa-calendar-check mr-2"></i> Konfirmasi Kehadiran
      </button>
    </div>
  </div>
</div>

<!-- MODAL RSVP + CHAT ROOM WA -->
<div
  id="rsvp-form-modal"
  class="modal-backdrop hidden fixed inset-0 z-[100] flex items-center justify-center p-6 py-6 bg-blur transition-opacity duration-300 opacity-0"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-content transform scale-95 transition-all w-full h-full overflow-y-auto">
    <div
      class="bg-white rounded-2xl shadow-2xl p-6 text-center relative"
      style="border: 2px solid var(--inv-accent)"
    >
      <h2 class="color-accent text-3xl font-accent mb-4">Detail Kehadiran</h2>

      <div class="space-y-4 text-left">
        <div>
          <label for="rsvp-name-modal" class="block text-sm font-bold mb-1">
            Nama Anda: <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="rsvp-name-modal"
            class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-color-accent focus:border-color-accent sm:text-sm"
            placeholder="Nama Anda"
          />
        </div>

        <div>
          <label for="rsvp-status-modal" class="block text-sm font-bold mb-1">
            Apakah Anda akan hadir? <span class="text-red-500">*</span>
          </label>
          <select
            id="rsvp-status-modal"
            class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-color-accent focus:border-color-accent sm:text-sm"
          >
            <option value="Hadir">Ya, saya akan hadir</option>
            <option value="Tidak Hadir"> Mohon maaf, saya tidak bisa hadir </option>
          </select>
        </div>

        <div>
          <label for="rsvp-message-modal" class="block text-sm font-bold mb-1 pt-2">
            Pesan / Doa (Opsional):
          </label>
          <textarea
            id="rsvp-message-modal"
            rows="3"
            class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-color-accent focus:border-color-accent sm:text-sm"
            placeholder="Tuliskan ucapan dan doa terbaik Anda di sini..."></textarea>
        </div>
      </div>

      <button
        id="send-rsvp-btn-modal"
        class="w-full mt-6 px-4 py-3 text-sm font-bold text-white bg-lime-600 hover:bg-lime-700 rounded-2xl transition duration-150"
      >
        <i class="fa-solid fa-envelope-circle-check mr-2"></i> Kirim Konfirmasi
      </button>

      <button onclick="closeModal('rsvp-form-modal')" class="mt-3 text-xs hover:block mx-auto">
        Batal
      </button>

      <div
        id="rsvp-messages-container"
        class="mt-6 max-h-80 min-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200"
      >
        <div id="rsvp-messages" class="flex flex-col space-y-2"></div>
      </div>

      <button id="load-more-btn" class="mt-2 text-sm text-lime-600 hover:underline">
        Lihat lebih banyak
      </button>
    </div>

    <div
      id="success-toast"
      class="fixed bottom-5 right-5 z-[500] hidden p-4 rounded-xl shadow-2xl transition-all duration-300 transform translate-x-full"
      style="background-color: #22c55e; color: white;"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-3 text-xl"></i>
        <span class="font-bold text-sm">Konfirmasi berhasil dikirim!</span>
      </div>
    </div>
  </div>
</div>

<script>
  //@ts-ignore

  import firebase from 'firebase/compat/app'
  import 'firebase/compat/database'

  const firebaseConfig = {
    apiKey: 'AIzaSyCDZ3zzCfugHEqXH-6pTpSjmO3ZHiuQlpQ',
    authDomain: 'undangan-aethersub.firebaseapp.com',
    databaseURL: 'https://undangan-aethersub-default-rtdb.asia-southeast1.firebasedatabase.app',
    projectId: 'undangan-aethersub'
  }

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig)
  }

  const db = firebase.database()
  let allMessages = []
  let visibleCount = 6

  window.showSuccessToast = function () {
    const toast = document.getElementById('success-toast')
    if (!toast) return
    toast.classList.remove('hidden')

    requestAnimationFrame(() => {
      toast.classList.remove('translate-x-full')
    })

    setTimeout(() => {
      toast.classList.add('translate-x-full')

      setTimeout(() => {
        toast.classList.add('hidden')
      }, 300)
    }, 3000)
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Menghapus rsvpCountModal dari inisialisasi
    const formBtn = document.getElementById('send-rsvp-btn-modal')
    const messagesDiv = document.getElementById('rsvp-messages')
    const nameInput = document.getElementById('rsvp-name-modal')
    const loadMoreBtn = document.getElementById('load-more-btn')
    const rsvpGreetingName = document.getElementById('rsvp-greeting-name')
    const rsvpStatusModal = document.getElementById('rsvp-status-modal')
    const rsvpMessageModal = document.getElementById('rsvp-message-modal')

    const guestName = window.getGuestNameFromUrl ? window.getGuestNameFromUrl() : 'Tamu'

    if (rsvpGreetingName) {
      rsvpGreetingName.textContent = guestName
    }
    if (nameInput) {
      nameInput.value = guestName.replace(/\+/g, ' ')
    }

    // Pengecekan null check sudah disesuaikan (rsvpCountModal dihapus)
    if (formBtn && nameInput && rsvpStatusModal && rsvpMessageModal) {
      formBtn.addEventListener('click', () => {
        const name = nameInput.value.trim() || 'Tamu Undangan'
        const status = rsvpStatusModal.value
        // const count dihapus
        const message = rsvpMessageModal.value

        if (!name) return alert('Nama harus diisi')
        // Validasi count dihapus

        db.ref('rsvp').push({
          name,
          status,
          count: 1, // Diberikan nilai default 1
          message,
          timestamp: Date.now()
        })

        window.showSuccessToast()

        rsvpStatusModal.value = 'Hadir'
        // rsvpCountModal.value = 1 dihapus
        rsvpMessageModal.value = ''
      })
    }

    function renderMessages() {
      if (!messagesDiv) return

      messagesDiv.innerHTML = ''
      const messagesToShow = allMessages.slice().reverse().slice(0, visibleCount)

      messagesToShow.forEach((data) => {
        const isHadir = data.status === 'Hadir'
        const wrapper = document.createElement('div')
        wrapper.className = `
            flex items-end mb-3 
            ${isHadir ? 'justify-start' : 'justify-end'} 
            opacity-0 translate-y-3
            `

        const avatar = document.createElement('div')
        const initials = data.name.charAt(0).toUpperCase()
        avatar.innerText = initials
        avatar.className = `
            w-8 h-8 rounded-full flex items-center justify-center
            text-white font-semibold shadow 
            bg-gray-400 flex-shrink-0
            `

        const time = new Date(data.timestamp)
        const hh = time.getHours().toString().padStart(2, '0')
        const mm = time.getMinutes().toString().padStart(2, '0')

        const bubble = document.createElement('div')
        bubble.className = `
            relative px-4 py-2 rounded-lg shadow max-w-[75%] w-fit break-words
            ${isHadir ? 'bg-lime-100 text-left rounded-bl-none' : 'bg-red-100 text-right rounded-br-none'}
            `

        bubble.innerHTML = `
            <div class="text-xs text-gray-500 font-semibold mb-1">
                ${data.name} • ${hh}:${mm}
            </div>
            <div class="text-sm mb-1">${data.message || '<i>Tidak ada pesan</i>'}</div>
            <div class="text-xs text-gray-600">Status: ${data.status}</div>
            `

        if (isHadir) {
          wrapper.appendChild(avatar)
          wrapper.appendChild(bubble)
        } else {
          wrapper.appendChild(bubble)
          wrapper.appendChild(avatar)
        }

        messagesDiv.appendChild(wrapper)

        requestAnimationFrame(() => {
          wrapper.style.transition = 'all 0.25s ease'
          wrapper.style.opacity = 1
          wrapper.style.transform = 'translateY(0)'
        })
      })

      messagesDiv.scrollTop = messagesDiv.scrollHeight
    }

    if (messagesDiv) {
      db.ref('rsvp')
        .orderByChild('timestamp')
        .on('value', (snapshot) => {
          const data = snapshot.val() || {}
          allMessages = Object.values(data).sort((a, b) => a.timestamp - b.timestamp)
          renderMessages()
        })
    }

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
        visibleCount += 6
        renderMessages()
      })
    }

    function cleanupOldMessages() {
      const now = Date.now()
      db.ref('rsvp').once('value', (snapshot) => {
        const data = snapshot.val() || {}
        Object.entries(data).forEach(([key, msg]) => {
          if (now - msg.timestamp > 24 * 60 * 60 * 1000) {
            db.ref('rsvp/' + key).remove()
          }
        })
      })
    }

    cleanupOldMessages()
    setInterval(cleanupOldMessages, 60 * 60 * 1000)
  })
</script>
